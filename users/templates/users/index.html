<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formations - Training Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 2rem;
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 20rem;
            max-height: 24rem;
            overflow-y: auto;
            z-index: 1000;
        }
        .notification-dropdown.show {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            max-width: 36rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .sortable:hover {
            background-color: #f1f5f9;
        }
        .sortable.asc::after {
            content: 'â†‘';
            margin-left: 0.5rem;
        }
        .sortable.desc::after {
            content: 'â†“';
            margin-left: 0.5rem;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar fixed md:sticky top-0 left-0 w-64 bg-white shadow-lg h-screen p-6 md:transform-none z-20" id="sidebar">
            <div class="flex items-center mb-8">
                <h2 class="text-xl font-bold text-blue-600">TMS</h2>
                <button class="md:hidden ml-auto text-blue-600" id="toggleSidebar">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <a href="#available-formations" class="block p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">Available Formations</a>
                    </li>
                    <li>
                        <a href="#participated-formations" class="block p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">My Participated Formations</a>
                    </li>
                    {% if user.user_role == 'manager' or user.user_role == 'department_chief' %}
                        <li>
                            <a href="#subordinate-employees" class="block p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">Users Under Supervision</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 container">
            <!-- Header -->
            <div class="card mb-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-blue-600" id="openSidebar">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-blue-600">Training Management System</h1>
                        <p class="text-gray-600">Welcome, {{ user.user_username }}! (Role: {{ user.user_role|capfirst }})</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <span class="notification-bell text-2xl cursor-pointer text-blue-600 hover:text-blue-800">
                            ðŸ””
                            {% if notifications.count > 0 %}
                                <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">{{ notifications.count }}</span>
                            {% endif %}
                        </span>
                        <div class="notification-dropdown" id="notificationDropdown">
                            {% for notification in notifications %}
                                <div class="notification-item p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer" data-notification-id="{{ notification.pk }}">
                                    <p class="text-sm text-gray-800">{{ notification.message }}</p>
                                    <span class="text-xs text-gray-500">{{ notification.created_at|date:"Y-m-d H:i" }}</span>
                                </div>
                            {% empty %}
                                <div class="notification-item p-4 text-sm text-gray-600">
                                    <p>No new notifications.</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <span class="user-icon text-2xl cursor-pointer text-blue-600 hover:text-blue-800"
                          data-user-username="{{ user.user_username }}"
                          data-user-email="{{ user.user_email }}"
                          data-user-role="{{ user.user_role }}"
                          data-user-nom="{{ user.user_lastname|default:'N/A' }}"
                          data-user-prenom="{{ user.user_firstname|default:'N/A' }}"
                          data-user-structure="{{ user.structure.structure_varchar|default:'N/A' }}"
                          data-user-department="{{ user.department.department_name|default:'N/A' }}"
                          data-user-state="{{ user.state|default:'N/A' }}">ðŸ‘¤</span>
                    <a href="{% url 'users:logout' %}" class="text-red-500 hover:underline">Logout</a>
                </div>
            </div>

            <!-- Available Formations -->
            <div id="available-formations" class="card mb-6">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Available Formations</h2>
                {% if formations %}
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <div class="flex-1">
                            <label for="formation-search-available" class="block text-sm font-medium text-gray-700 mb-1">Search by Title</label>
                            <input type="text" id="formation-search-available" class="w-full max-w-xs border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" placeholder="Enter formation title...">
                        </div>
                        <div class="flex-1">
                            <label for="formation-level-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Level</label>
                            <select id="formation-level-filter" class="w-full max-w-xs border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">All Levels</option>
                                {% for formation in formations %}
                                    {% if formation.formation_niveau %}
                                        <option value="{{ formation.formation_niveau }}">{{ formation.formation_niveau }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for formation in formations %}
                            <div class="formation-card bg-gray-50 rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow"
                                 data-formation-id="{{ formation.formation_id }}"
                                 data-title="{{ formation.formation_titre }}"
                                 data-ref="{{ formation.formation_ref }}"
                                 data-level="{{ formation.formation_niveau }}"
                                 data-country="{{ formation.formation_pays }}"
                                 data-duration="{{ formation.formation_duree }}"
                                 data-cost="{{ formation.formation_cout }}"
                                 data-description="{{ formation.formation_description }}"
                                 data-prerequisites="{{ formation.formation_prerequis|default:'None' }}"
                                 data-program="{{ formation.formation_programme|default:'None' }}"
                                 data-target="{{ formation.formation_cible|default:'None' }}"
                                 data-objective="{{ formation.formation_objectif|default:'None' }}"
                                 data-is-participated="false">
                                <h3 class="text-lg font-semibold text-blue-600">{{ formation.formation_titre }}</h3>
                                <p class="text-sm"><span class="font-medium">Reference:</span> {{ formation.formation_ref }}</p>
                                <p class="text-sm"><span class="font-medium">Level:</span> {{ formation.formation_niveau }}</p>
                                <p class="text-sm"><span class="font-medium">Country:</span> {{ formation.formation_pays }}</p>
                                <p class="text-sm"><span class="font-medium">Duration:</span> {{ formation.formation_duree }} days</p>
                                <p class="text-sm"><span class="font-medium">Cost:</span> ${{ formation.formation_cout }}</p>
                                <p class="text-sm"><span class="font-medium">Description:</span> {{ formation.formation_description|truncatewords:20 }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600">No formations available.</p>
                {% endif %}
            </div>

            <!-- Participated Formations -->
            <div id="participated-formations" class="card mb-6">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">My Participated Formations</h2>
                {% if user_formations %}
                    <div class="mb-4">
                        <label for="formation-search" class="block text-sm font-medium text-gray-700 mb-1">Search by Title</label>
                        <input type="text" id="formation-search" class="w-full max-w-xs border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" placeholder="Enter formation title...">
                    </div>
                    <table class="w-full border-collapse participated-table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-3 text-left text-sm font-medium text-blue-600">Formation Title</th>
                                <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="state" data-direction="none">State</th>
                                <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="date" data-direction="none">Date</th>
                                <th class="p-3 text-left text-sm font-medium text-blue-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user_formation in user_formations %}
                                <tr class="border-b">
                                    <td class="p-3 text-sm">{{ user_formation.formation.formation_titre }}</td>
                                    <td class="p-3 text-sm capitalize {% if user_formation.state_formation == 'pending' %}text-yellow-500{% elif user_formation.state_formation == 'approved' %}text-green-500{% else %}text-red-500{% endif %}">
                                        {{ user_formation.state_formation }}
                                    </td>
                                    <td class="p-3 text-sm">{{ user_formation.valide_date|date:"Y-m-d" }}</td>
                                    <td class="p-3">
                                        <a href="#" class="view-details-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm"
                                           data-formation-id="{{ user_formation.formation.formation_id }}"
                                           data-title="{{ user_formation.formation.formation_titre }}"
                                           data-ref="{{ user_formation.formation.formation_ref }}"
                                           data-level="{{ user_formation.formation.formation_niveau }}"
                                           data-country="{{ user_formation.formation.formation_pays }}"
                                           data-duration="{{ user_formation.formation.formation_duree }}"
                                           data-cost="{{ user_formation.formation.formation_cout }}"
                                           data-description="{{ user_formation.formation.formation_description }}"
                                           data-prerequisites="{{ user_formation.formation.formation_prerequis|default:'None' }}"
                                           data-program="{{ user_formation.formation.formation_programme|default:'None' }}"
                                           data-target="{{ user_formation.formation.formation_cible|default:'None' }}"
                                           data-objective="{{ user_formation.formation.formation_objectif|default:'None' }}"
                                           data-is-participated="true">View Details</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-gray-600">You have not participated in any formations.</p>
                {% endif %}
            </div>

            <!-- Users Under My Supervision -->
            {% if user.user_role == 'manager' or user.user_role == 'department_chief' %}
                <div id="subordinate-employees" class="card mb-6">
                    <h2 class="text-xl font-semibold text-blue-600 mb-4">Users Under My Supervision</h2>
                    {% if subordinate_employees %}
                        <div class="flex flex-col sm:flex-row gap-4 mb-6">
                            <div class="flex-1">
                                <label for="employee-search" class="block text-sm font-medium text-gray-700 mb-1">Search by Username</label>
                                <input type="text" id="employee-search" class="w-full max-w-xs border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" placeholder="Enter username...">
                            </div>
                            <div class="flex-1">
                                <label for="employee-formation-search" class="block text-sm font-medium text-gray-700 mb-1">Search by Formation</label>
                                <input type="text" id="employee-formation-search" class="w-full max-w-xs border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" placeholder="Enter formation title...">
                            </div>
                        </div>
                        <table class="w-full border-collapse employees-table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="username" data-direction="none">Username</th>
                                    <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="email" data-direction="none">Email</th>
                                    <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="role" data-direction="none">Role</th>
                                    <th class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="department" data-direction="none">Department</th>
                                    <th ricchi  class="p-3 text-left text-sm font-medium text-blue-600 sortable" data-sort="structure" data-direction="none">Structure</th>
                                    <th class="p-3 text-left text-sm font-medium text-blue-600">Formations</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in subordinate_employees %}
                                    <tr class="border-b">
                                        <td class="p-3 text-sm">{{ employee.user_username }}</td>
                                        <td class="p-3 text-sm">{{ employee.user_email }}</td>
                                        <td class="p-3 text-sm capitalize">{{ employee.user_role }}</td>
                                        <td class="p-3 text-sm">{{ employee.department.department_name|default:'N/A' }}</td>
                                        <td class="p-3 text-sm">{{ employee.structure.structure_varchar|default:'N/A' }}</td>
                                        <td class="p-3 text-sm">
                                            {% with employee_formations=employee.user_formations.all %}
                                                {% if employee_formations %}
                                                    <ul class="list-disc pl-5">
                                                        {% for uf in employee_formations %}
                                                            <li data-formation-title="{{ uf.formation.formation_titre }}">{{ uf.formation.formation_titre }} ({{ uf.state_formation|capfirst }})</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    None
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-gray-600">No users under your supervision.</p>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Modals -->
            <div id="formationModal" class="modal">
                <div class="modal-content">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg flex justify-between items-center">
                        <h3 id="modal-title" class="text-lg font-semibold"></h3>
                        <span class="close text-2xl cursor-pointer hover:text-gray-200">Ã—</span>
                    </div>
                    <div class="p-6 space-y-4">
                        <p><span class="font-medium text-blue-600">Reference:</span> <span id="modal-ref"></span></p>
                        <p><span class="font-medium text-blue-600">Level:</span> <span id="modal-level"></span></p>
                        <p><span class="font-medium text-blue-600">Country:</span> <span id="modal-country"></span></p>
                        <p><span class="font-medium text-blue-600">Duration:</span> <span id="modal-duration"></span> days</p>
                        <p><span class="font-medium text-blue-600">Cost:</span> <span id="modal-cost"></span> USD</p>
                        <p><span class="font-medium text-blue-600">Description:</span> <span id="modal-description"></span></p>
                        <p><span class="font-medium text-blue-600">Prerequisites:</span> <span id="modal-prerequisites"></span></p>
                        <p><span class="font-medium text-blue-600">Program:</span> <span id="modal-program"></span></p>
                        <p><span class="font-medium text-blue-600">Target:</span> <span id="modal-target"></span></p>
                        <p><span class="font-medium text-blue-600">Objective:</span> <span id="modal-objective"></span></p>
                    </div>
                    <div class="p-6 border-t border-gray-200 flex flex-col items-center gap-2">
                        <button id="participateBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Participate</button>
                        <div id="modal-message" class="text-sm"></div>
                    </div>
                </div>
            </div>

            <div id="userModal" class="modal">
                <div class="modal-content">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg flex justify-between items-center">
                        <h3 class="text-lg font-semibold">User Profile</h3>
                        <span class="close text-2xl cursor-pointer hover:text-gray-200">Ã—</span>
                    </div>
                    <div class="p-6 space-y-4" id="userModalBody"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to get CSRF token
        function getCsrfToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content || '{{ csrf_token }} ';
        }

        // DOM elements
        const formationModal = document.getElementById('formationModal');
        const userModal = document.getElementById('userModal');
        const modalTitle = document.getElementById('modal-title');
        const modalRef = document.getElementById('modal-ref');
        const modalLevel = document.getElementById('modal-level');
        const modalCountry = document.getElementById('modal-country');
        const modalDuration = document.getElementById('modal-duration');
        const modalCost = document.getElementById('modal-cost');
        const modalDescription = document.getElementById('modal-description');
        const modalPrerequisites = document.getElementById('modal-prerequisites');
        const modalProgram = document.getElementById('modal-program');
        const modalTarget = document.getElementById('modal-target');
        const modalObjective = document.getElementById('modal-objective');
        const modalMessage = document.getElementById('modal-message');
        const participateBtn = document.getElementById('participateBtn');
        const closeButtons = document.getElementsByClassName('close');
        const notificationBell = document.querySelector('.notification-bell');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const userIcon = document.querySelector('.user-icon');
        const searchInputParticipated = document.getElementById('formation-search');
        const searchInputAvailable = document.getElementById('formation-search-available');
        const levelFilter = document.getElementById('formation-level-filter');
        const searchInputEmployees = document.getElementById('employee-search');
        const searchInputEmployeeFormations = document.getElementById('employee-formation-search');
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('openSidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');

        let currentFormationId = null;

        // Sidebar toggle
        openSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
        });

        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // Close modal function
        function closeModals() {
            formationModal.classList.remove('show');
            userModal.classList.remove('show');
        }

        // Notification dropdown toggle
        if (notificationBell) {
            notificationBell.addEventListener('click', (e) => {
                e.stopPropagation();
                const badge = notificationBell.querySelector('.badge');
                if (badge) badge.remove();
                notificationDropdown.classList.toggle('show');
            });
        }

        // Close notification dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!notificationBell.contains(event.target) && !notificationDropdown.contains(event.target)) {
                notificationDropdown.classList.remove('show');
            }
        });

        // Mark notification as read
        document.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', () => {
                const notificationId = item.getAttribute('data-notification-id');
                if (notificationId) {
                    fetch("{% url 'users:mark_notification_read' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({ notification_id: notificationId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            item.classList.add('bg-gray-100');
                            const remainingItems = notificationDropdown.querySelectorAll('.notification-item[data-notification-id]');
                            if (remainingItems.length === 0) {
                                notificationDropdown.innerHTML = `
                                    <div class="notification-item p-4 text-sm text-gray-600">
                                        <p>No new notifications.</p>
                                    </div>
                                `;
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        });

        // Search for participated formations
        if (searchInputParticipated) {
            searchInputParticipated.addEventListener('input', () => {
                const query = searchInputParticipated.value.toLowerCase();
                const rows = document.querySelectorAll('.participated-table tbody tr');
                rows.forEach(row => {
                    const title = row.querySelector('td:first-child').textContent.toLowerCase();
                    row.style.display = title.includes(query) ? '' : 'none';
                });
            });
        }

        // Update formation grid
        function updateFormationGrid() {
            const searchQuery = searchInputAvailable.value.toLowerCase();
            const selectedLevel = levelFilter.value;
            const cards = document.querySelectorAll('.formation-card');
            cards.forEach(card => {
                const title = card.getAttribute('data-title').toLowerCase();
                const level = card.getAttribute('data-level');
                const matchesSearch = title.includes(searchQuery);
                const matchesFilter = selectedLevel === '' || level === selectedLevel;
                card.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
        }

        if (searchInputAvailable) {
            searchInputAvailable.addEventListener('input', updateFormationGrid);
        }

        if (levelFilter) {
            levelFilter.addEventListener('change', updateFormationGrid);
            const options = Array.from(levelFilter.options);
            const uniqueValues = new Set();
            options.forEach(opt => {
                if (opt.value && uniqueValues.has(opt.value)) {
                    opt.remove();
                } else {
                    uniqueValues.add(opt.value);
                }
            });
        }

        // Search for employees (by username and formation)
        function updateEmployeeTable() {
            const usernameQuery = searchInputEmployees?.value.toLowerCase() || '';
            const formationQuery = searchInputEmployeeFormations?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('.employees-table tbody tr');
            rows.forEach(row => {
                const username = row.querySelector('td:first-child').textContent.toLowerCase();
                const formationCells = row.querySelector('td:last-child').querySelectorAll('li[data-formation-title]');
                const formationsText = Array.from(formationCells)
                    .map(cell => cell.getAttribute('data-formation-title').toLowerCase())
                    .join(' ');
                const matchesUsername = username.includes(usernameQuery);
                const matchesFormation = formationQuery === '' || formationsText.includes(formationQuery);
                row.style.display = matchesUsername && matchesFormation ? '' : 'none';
            });
        }

        if (searchInputEmployees) {
            searchInputEmployees.addEventListener('input', updateEmployeeTable);
        }

        if (searchInputEmployeeFormations) {
            searchInputEmployeeFormations.addEventListener('input', updateEmployeeTable);
        }

        // Table sorting
        function sortTable(tableSelector, sortKey, direction) {
            const tbody = document.querySelector(`${tableSelector} tbody`);
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                let aValue, bValue;
                if (tableSelector === '.participated-table') {
                    if (sortKey === 'state') {
                        aValue = a.querySelector('td:nth-child(2)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    } else if (sortKey === 'date') {
                        aValue = new Date(a.querySelector('td:nth-child(3)').textContent);
                        bValue = new Date(b.querySelector('td:nth-child(3)').textContent);
                    }
                } else if (tableSelector === '.employees-table') {
                    if (sortKey === 'username') {
                        aValue = a.querySelector('td:nth-child(1)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(1)').textContent.toLowerCase();
                    } else if (sortKey === 'email') {
                        aValue = a.querySelector('td:nth-child(2)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    } else if (sortKey === 'role') {
                        aValue = a.querySelector('td:nth-child(3)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    } else if (sortKey === 'department') {
                        aValue = a.querySelector('td:nth-child(4)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    } else if (sortKey === 'structure') {
                        aValue = a.querySelector('td:nth-child(5)').textContent.toLowerCase();
                        bValue = b.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    }
                }
                if (!aValue || !bValue) return 0;
                return direction === 'asc' ?
                    (aValue.localeCompare ? aValue.localeCompare(bValue) : aValue - bValue) :
                    (bValue.localeCompare ? bValue.localeCompare(aValue) : bValue - aValue);
            });
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Sorting event listeners
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const tableSelector = header.closest('table').classList.contains('participated-table') ? '.participated-table' : '.employees-table';
                const sortKey = header.getAttribute('data-sort');
                const currentDirection = header.getAttribute('data-direction');
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                header.setAttribute('data-direction', newDirection);
                header.classList.remove('asc', 'desc');
                header.classList.add(newDirection);
                document.querySelectorAll(`${tableSelector} th.sortable`).forEach(h => {
                    if (h !== header) {
                        h.setAttribute('data-direction', 'none');
                        h.classList.remove('asc', 'desc');
                    }
                });
                sortTable(tableSelector, sortKey, newDirection);
                if (tableSelector === '.participated-table' && searchInputParticipated?.value) {
                    const query = searchInputParticipated.value.toLowerCase();
                    const rows = document.querySelectorAll('.participated-table tbody tr');
                    rows.forEach(row => {
                        const title = row.querySelector('td:first-child').textContent.toLowerCase();
                        row.style.display = title.includes(query) ? '' : 'none';
                    });
                } else if (tableSelector === '.employees-table') {
                    updateEmployeeTable();
                }
            });
        });

        // Open formation modal
        function openFormationModal(element) {
            currentFormationId = element.getAttribute('data-formation-id');
            modalTitle.textContent = element.getAttribute('data-title') || 'N/A';
            modalRef.textContent = element.getAttribute('data-ref') || 'N/A';
            modalLevel.textContent = element.getAttribute('data-level') || 'N/A';
            modalCountry.textContent = element.getAttribute('data-country') || 'N/A';
            modalDuration.textContent = element.getAttribute('data-duration') || 'N/A';
            modalCost.textContent = element.getAttribute('data-cost') || 'N/A';
            modalDescription.textContent = element.getAttribute('data-description') || 'N/A';
            modalPrerequisites.textContent = element.getAttribute('data-prerequisites') || 'None';
            modalProgram.textContent = element.getAttribute('data-program') || 'None';
            modalTarget.textContent = element.getAttribute('data-target') || 'None';
            modalObjective.textContent = element.getAttribute('data-objective') || 'None';
            const isParticipated = element.getAttribute('data-is-participated') === 'true';
            participateBtn.disabled = isParticipated;
            modalMessage.textContent = isParticipated ? 'You are already enrolled in this formation.' : '';
            modalMessage.className = isParticipated ? 'text-green-500' : '';
            formationModal.classList.add('show');
            userModal.classList.remove('show');
        }

        // Open user modal
        function openUserModal(element) {
            const userData = {
                'Username': element.getAttribute('data-user-username') || 'N/A',
                'Email': element.getAttribute('data-user-email') || 'N/A',
                'Role': element.getAttribute('data-user-role') || 'N/A',
                'First Name': element.getAttribute('data-user-prenom') || 'N/A',
                'Last Name': element.getAttribute('data-user-nom') || 'N/A',
                'Structure': element.getAttribute('data-user-structure') || 'N/A',
                'Department': element.getAttribute('data-user-department') || 'N/A',
                'State': element.getAttribute('data-user-state') || 'N/A'
            };
            const modalBody = document.getElementById('userModalBody');
            modalBody.innerHTML = '';
            for (const [key, value] of Object.entries(userData)) {
                if (value && value !== 'N/A') {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="font-medium text-blue-600">${key}:</span> ${value}`;
                    modalBody.appendChild(p);
                }
            }
            userModal.classList.add('show');
            formationModal.classList.remove('show');
        }

        // Event listeners
        userIcon.addEventListener('click', () => openUserModal(userIcon));
        document.querySelectorAll('.formation-card').forEach(card => {
            card.addEventListener('click', () => openFormationModal(card));
        });
        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openFormationModal(btn);
            });
        });
        Array.from(closeButtons).forEach(btn => {
            btn.addEventListener('click', closeModals);
        });
        window.addEventListener('click', (event) => {
            if (event.target === formationModal || event.target === userModal) {
                closeModals();
            }
        });

        // Participate button
        participateBtn.addEventListener('click', () => {
            if (!currentFormationId) {
                modalMessage.textContent = 'No formation selected.';
                modalMessage.className = 'text-red-500';
                return;
            }
            fetch("{% url 'users:participate_formation' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ formation_id: currentFormationId })
            })
            .then(response => response.json())
            .then(data => {
                modalMessage.textContent = data.message;
                modalMessage.className = `text-${data.status === 'success' ? 'green' : 'red'}-500`;
                if (data.status === 'success') {
                    participateBtn.disabled = true;
                    const card = document.querySelector(`.formation-card[data-formation-id="${currentFormationId}"]`);
                    if (card) card.setAttribute('data-is-participated', 'true');
                }
            })
            .catch(error => {
                modalMessage.textContent = 'An error occurred.';
                modalMessage.className = 'text-red-500';
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>